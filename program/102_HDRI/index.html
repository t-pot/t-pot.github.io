<head>
	<title>t-potwHDR摜tH[}bgx</title>
	<link rel="stylesheet" type="text/css" href="../if.css">
</head>
<meta http-equiv=Content-Type content="text/html; charset=shift_jis">
<body>


<div class="contents">
<center>
<BR CLEAR=ALL>
<BR CLEAR=ALL>
<h1>HDR摜tH[}bg</h1><br>
<h3>` The RADIANCE Picture File Format `</h3>
<BR CLEAR=ALL>
<BR CLEAR=ALL>
<BR CLEAR=ALL>
<image src = "title.png">
<br>
<hr>
</center>
<div>


<h2>͂߂</h2>


<p>
ꂾHDRAHDRƂĂ̒ŁAu.hdrv̊gqł킳HDR摜tH[}bgĂȂ̂͂ł傤BHDR摜tH[}bg̓GNXv[łvr[ł鐢EłB<br>
ƂƂŁAu.hdrv̉摜ǂݍŃeNX`RGBE(A)ŕۑ郋[`Ă܂B<br>
܁AۖA<a href="http://radsite.lbl.gov/radiance/refer/Notes/picture_format.html">"The RADIANCE Picture File Format"</a>̃y[W̃\[XDirectXpɂ܂Ƃ߂łB<br>
HDR摜tH[}bg̃f[^́A<a href="http://www.debevec.org/">Paul Debevec</a> ɂ<a href="http://www.debevec.org/Probes/">Light Probe Image Gallery</a> ̃y[Wɂ̂ŁAĂ܂B<br>
܂AŎBe摜łA<a href="http://www.debevec.org/HDRShop/">HDR Shop</a>gĉH΁AHDR摜tH[}bg̃f[^쐬邱Ƃł܂ĩN<a href="http://www.debevec.org/">Paul Debevec</a>炯ȂjB
</p>
<p>
ŁA̂悤ɃvOłB
</p>
<ul style = "LIST-STYLE-TYPE:none">
<li><a href="src.zip">src.zip (HDR摜tH[}bg:DirectX 9)</a>
</ul>
<p>
vOł́AHDR摜tH[}bgǂݍŁuFactored BRDFṽvOɃtlt̊}bvƂĒǉ܂B
</p>

<p>
\[Xɂ́A̂悤ɓKɃt@CĂ܂B<br>
厖ȃ\[X͎̂悤ɂȂ܂B
</p>
<table>
<tr><td><a href="hdr_h.html">hdr.h</a></td><td>ĂяoŃCN[hwb_</td></tr>
<tr><td><a href="hdr_cpp.html">hdr.cpp</a></td><td>HDR摜tH[}bg̃t@CŃR[h\[X</td></tr>
<tr><td><a href="main_h.html">main.h</a></td><td>AvP[Ṽwb_</td></tr>
<tr><td><a href="main_cpp.html">main.cpp</a></td><td>AvP[Ṽ\[X</td></tr>
<tr><td><a href="hlsl_fx.html">hlsl.fx</a></td><td>AvP[VŎgHLSLvO</td></tr>
</table>
<p>
ǂuhdr.hvƁuhdr.cppvςĎgƂȂł傤c
</p>


<h2>HDR摜tH[}bg</h2>


<p>
āAHDR摜tH[}bg͂ǂ̂悤Ȃ̂ł傤H<br>
geLXgGfB^ŏƁÂ悤ɂȂĂ܂B
</p>
<pre class="CodeBlock">
#?RADIANCE
# Made with 100% pure HDR Shop
FORMAT=32-bit_rle_rgbe
EXPOSURE=          1.0000000000000

-Y 1000 +X 1000
    7\   [\ ZZZ\[[ [^[[[_[[`\[[]`eee]e[^^][[\\`[^[\\ [\ [ \\        M   NN N+P NTOPNWNOXRNNTY```S_PUUTONQPYNUNNP NP N NN        7                                \ ZZZ\\Z[c\c\fjmjlgmloopmsvoopoo
</pre>
<p>
̃RgtH[}bgɃTCYĂ̌͂ႲƂ킯킩ȂȂ悤Ɍ܂B<br>
HDR摜tH[}bg͍ŏ̓eLXgf[^ŁAroCif[^ɐ؂ւȃf[^łB<br>
̒ǵA󔒂Ȃs͂ŁAwb_ƃf[^ɕ\Ă܂B
</p>
<pre class="CodeBlock">
+------------------+
|      wb_      |
+------------------+
|    󔒂̂Ps    |
+------------------+
|      f[^      |
+------------------+
</pre>
<p>
wb_́Au#?vɑĂ̎ނ\uRADIANCEv܂iƂĂÁuRADIANCEvT|[g܂jB<br>
̌Łu***=***v̍\ĂśAf[^̑ȂǂLq܂(́AFORMATłɂ32-bit_rle_rgbeT|[g܂)B
</p>
<pre class="CodeBlock">
#?<font color="yellow">RADIANCE</font>
# Made with 100% pure HDR Shop
<font color="orange">FORMAT=32-bit_rle_rgbe</font>
<font color="orange">EXPOSURE=          1.0000000000000</font>
</pre>

<p>
f[^́Aŏɉ摜̑傫\eLXgsāAƂ̓oCif[^ɂȂ܂B<br>
摜̑傫̃̕tH[}bǵAu-Y M +X Nv̂悤YOɂƂ́Af[^Ns̃f[^M񂠂\ɂȂĂāAu+X N -Y Mv̎ɂ́AM̃f[^Nsf[^̍\Ă邱Ƃ킵Ă܂ÁAu-Y M +X NvΉĂ܂BȂAY̑O-Ă̂́AeNX`̃f[^ɐLтĂƂĂ܂i܂Aʂ̃eNX`f[^ƂƂłjB
</p>
<pre class="CodeBlock">
-Y 1000 +X 1000
    7\   [\ ZZZ\[[ [^[[[_[[`\[[]`eee]e[^^][[\\`[^[\\ [\ [ \\        M   NN N+P NTOPNWNOXRNNTY```S_PUUTONQPYNUNNP NP N NN        7                                \ ZZZ\\Z[c\c\fjmjlgmloopmsvoopoo
</pre>
<p>
Ȃ݂ɁǍɑoCĩf[^łAoCiGfB^ŊJĂ悭ƁA̕ŋ؂Ă邱Ƃ킩܂B
</p>
<pre class="CodeBlock">
0x02 0x02 0x03 0xE8 RR RR RR RR GG GG GG GG GG GG GG GG BB BB BB BB EE EE EE EE EE
0x02 0x02 0x03 0xE8 RR RR RR RR RR RR GG GG GG GG GG GG BB BB BB BB BB BB BB BB EE EE EE
0x02 0x02 0x03 0xE8 RR RR RR RR GG GG GG GG BB BB BB BB EE EE EE EE
0x02 0x02 0x03 0xE8 RR RR RR RR RR RR RR RR RR RR GG GG GG GG GG GG BB BB BB BB BB BB EE EE EE EE
</pre>
<p>
ۂ̃f[^ł́A̗񂪉摜̗񐔂邱Ƃ킩Ǝv܂B<br>
ŁAŏ̂QoCǵu0x02v̓}WbNio[łBÂo[W̃f[^ł͂̕قȂĂāAƋʂ邽߂ɐ݂Ă܂B<br>
̌̂QoCǵA摜̕QoCgŌ̂łB̒lƐقǂ̃eLXgɂ镝̈Ⴂf[^̐邱Ƃł܂B
ȂA̕8`0x7fff܂ł̒lĂāȂ傫𒴂ijTCỶ摜́AuÂo[Wv̓ǂݕŃT|[g܂íAk@Ŋi[܂jB
<br>
Ƃ́Ã̗f[^ɂȂ܂BԁA΁AAŵS̃f[^AĂ܂Ƃ߂Ă܂B<br>
ẃA128ƂĂQׂ̂̋eFɗ^܂B܂Ả摜tH[}bgɂFf[^́A
</p>
<pre class="CodeBlock">
 = R * pow(2,E-128)
 = G * pow(2,E-128)
 = B * pow(2,E-128)
</pre>
<p>
ɂȂ܂B
ŁARAGAB́A摜f[^瓾FŁAE͉摜f[^瓾włB
</p>
<p>
̃f[^͉ϒŁAOXkĂ܂B
̓IȈk@́Aŏɓǂݍ񂾃f[^128傫΁A̎̃f[^ŏ̃f[^128܂B
</p>
<pre class="CodeBlock">
0x83 0x0a -> 0x0a 0x0a 0x0a
</pre>
<p>
ȂAǂݍ񂾃f[^128ȉȂ΁Ǎ̃f[^ǂݍ񂾃f[^̂܂܏o͂܂B܂AkĂȂf[^̌㉽\܂B
</p>
<pre class="CodeBlock">
0x03 0x0a 0x0b 0x0c -> 0x0a 0x0b 0x0c
</pre>
<p>
Ƃ́ǍJԂōss܂ő܂B
</p>


<h2>vÕt[</h2>


<p>
āAȏ̓ǂݍ݂ǂĂ邩ƂƂłÁÂ悤Ȋ֐`Ď܂B
</p>
<pre class="CodeBlock">
hdr.h
<font color="deepskyblue">0013:</font> <font color="blue">namespace</font> HDR{
<font color="deepskyblue">0014:</font>     <font color="cyan">//-----------------------------------------------------------------------------</font>
<font color="deepskyblue">0015:</font>     <font color="cyan">// HDR t@C̓ǂݍ</font>
<font color="deepskyblue">0016:</font>     <font color="cyan">//-----------------------------------------------------------------------------</font>
<font color="deepskyblue">0017:</font>     HRESULT CreateTextureFromFile(
<font color="deepskyblue">0018:</font>         LPDIRECT3DDEVICE9 pDevice,
<font color="deepskyblue">0019:</font>         LPCTSTR pSrcFile,
<font color="deepskyblue">0020:</font>         LPCTSTR *pErr,
<font color="deepskyblue">0021:</font>         LPDIRECT3DTEXTURE9 *pTexture);
<font color="deepskyblue">0022:</font> 
<font color="deepskyblue">0023:</font> }<font color="cyan">// namespace HDR</font>
</pre>
<p>
pDevice DirectX̃foCXŁApSrcFile͓ǂݍރt@CłB
pTexture ͓ǂݍ񂾃f[^ʂ̃eNX`ŁApErr ̓G[ƂɁÃG[bZ[Wfo܂B
</p>
<p>
֐̒ł͎̂悤ɍsĂ܂B
</p>
<pre class="CodeBlock">
t@CJ
@@
wb_ǂݍ
@@
摜TCY𒲂ׂ
@@
D3DXCreateTexture ŃeNX`𐶐
@@
eNX`bN
@@
OXf[^ǂݍ݂ȂeNX`ɏ
@@
eNX`̃bNJ
</pre>
<p>
̓IȃR[h̉́AĂǃtH[}bg̉̂܂܂ȗiłłHjB
</p>


<h2>HDR摜g</h2>


<p>
āÃeNX`ǂ̂悤ɎĝƂƂłA
sNZVF[_2_0LDR̃sNZ̐Fɕϊ邱Ƃł܂B<br>
{IȐF̏o͕@́AeNX`œǂݎAt@0.5̃ItZbgāAQׂ̂悵ĐFɏo͂܂B<br>
0.5ň̂́AQTUiKłPQW̒lƂĒ`ẘl̃sNZVF[_œǂݍ܂ꂽƂ̒l0.5łB
</p>
<pre class="CodeBlock">
hlsl.fx
<font color="deepskyblue">0180:</font> <font color="cyan">// -------------------------------------------------------------</font>
<font color="deepskyblue">0181:</font> <font color="cyan">// HDRLDRɕϊsNZVF[_vO</font>
<font color="deepskyblue">0182:</font> <font color="cyan">// -------------------------------------------------------------</font>
<font color="deepskyblue">0183:</font> float4 HDR_PS(PS_INPUT In) : COLOR
<font color="deepskyblue">0184:</font> {   
<font color="deepskyblue">0185:</font>     float4 ldr = (float4)0;
<font color="deepskyblue">0186:</font>     
<font color="deepskyblue">0187:</font>     float4 hdr = tex2D( SampEnv, In.Tex );
<font color="deepskyblue">0188:</font>     
<font color="deepskyblue">0189:</font>     ldr.rgb = saturate(hdr * pow(2, 255*(hdr.a - 0.5) ));
<font color="deepskyblue">0190:</font>     
<font color="deepskyblue">0191:</font>     <font color="blue">return</font> ldr;
<font color="deepskyblue">0192:</font> }
</pre>

<p>
̃vOł́AHDR摜}bvŎg܂B<br>
XtBA}bvHDR摜ǂݍŁAƂSchlick̋ߎɂtlĂLDRɖ߂ĉZ܂B<br>
ŁANvVv́Ar[Wnł̖@xNg⎋xNgłBr[Wnł̎xNǵA_̈ʒulȂߎƂĂƓꎋł̂ŁA̋ߎ𗘗pČvZʂ炵Ă܂iƌvZĂAႢ͂悭킩܂jB
</p>
<pre class="CodeBlock">
hlsl.fx
<font color="deepskyblue">0157:</font> float4 PS(VS_OUTPUT In) : COLOR
<font color="deepskyblue">0158:</font> {   
<font color="deepskyblue">0159:</font>     float4 v = tex2D( SampP, In.v );
<font color="deepskyblue">0160:</font>     float4 h = tex2D( SampP, In.h );
<font color="deepskyblue">0161:</font>     float4 l = tex2D( SampQ, In.l );
<font color="deepskyblue">0162:</font>     float4 gross = alpha * v * h * l * In.Intensity;
<font color="deepskyblue">0163:</font>     
<font color="deepskyblue">0164:</font>     <font color="cyan">// }bv</font>
<font color="deepskyblue">0165:</font>     <font color="yellow">float3 Nv = normalize(In.Nv);
<font color="deepskyblue">0166:</font>     float3 Vv = float3(0,0,-1);
<font color="deepskyblue">0167:</font>     float3 r = 2 * dot(Nv, Vv)*Nv - Vv;
<font color="deepskyblue">0168:</font>     <font color="blue">float</font>  m = 0.5 * rsqrt(dot(Nv+Vv,Nv+Vv));<font color="cyan">// Ki萔</font>
<font color="deepskyblue">0169:</font>     float2 env_coord = {m * r.x + 0.5, - m * r.y + 0.5};
<font color="deepskyblue">0170:</font>     float4 hdr = tex2D( SampEnv, env_coord );
<font color="deepskyblue">0171:</font>     
<font color="deepskyblue">0172:</font>     <font color="blue">float</font> F = 0.9*pow(1-dot(Nv,r), 4) + 0.1;<font color="cyan">// ␳ꂽtl</font>
<font color="deepskyblue">0173:</font>     
<font color="deepskyblue">0174:</font>     <font color="cyan">// HDRLDRɕϊ</font>
<font color="deepskyblue">0175:</font>     float3 ldr = saturate( F * hdr.rgb * pow(2, 255*(hdr.a - 0.5) ));</font>
<font color="deepskyblue">0176:</font>     
<font color="deepskyblue">0177:</font>     <font color="cyan">// ŏIIɍ</font>
<font color="deepskyblue">0178:</font>     <font color="blue">return</font> gross<font color="yellow"> + float4(ldr,0)</font>;
<font color="deepskyblue">0179:</font> }
</pre>

<p>
ȂA_VF[_vÓÂ悤ɂȂ܂B
uFactored BRDFṽvOɁAr[Wnł̖@xNgǉ̂ɂȂ܂B
</p>
<pre class="CodeBlock">
hlsl.fx
<font color="deepskyblue">0119:</font> <font color="cyan">// -------------------------------------------------------------</font>
<font color="deepskyblue">0120:</font> <font color="cyan">// _VF[_vO</font>
<font color="deepskyblue">0121:</font> <font color="cyan">// -------------------------------------------------------------</font>
<font color="deepskyblue">0122:</font> VS_OUTPUT VS(VS_INPUT In)
<font color="deepskyblue">0123:</font> {   
<font color="deepskyblue">0124:</font>     VS_OUTPUT Out = (VS_OUTPUT)0;            <font color="cyan">// o̓f[^</font>
<font color="deepskyblue">0125:</font>     
<font color="deepskyblue">0126:</font>     <font color="cyan">// ʒuW</font>
<font color="deepskyblue">0127:</font>     Out.Pos = mul( In.Pos, mWVP );
<font color="deepskyblue">0128:</font>     
<font color="deepskyblue">0129:</font>     <font color="cyan">// \ʍWn̊xNg߂</font>
<font color="deepskyblue">0130:</font>     float3 N = In.Normal;                   <font color="cyan">// @xNg</font>
<font color="deepskyblue">0131:</font>     float3 B = float3(0,1,0);               <font color="cyan">// ]@xNg</font>
<font color="deepskyblue">0132:</font>     float3 T = normalize(cross(N,B));       <font color="cyan">// ڃxNg</font>
<font color="deepskyblue">0133:</font>     B = cross(T,N);
<font color="deepskyblue">0134:</font>     
<font color="deepskyblue">0135:</font>     <font color="cyan">// KvȃxNgvZ</font>
<font color="deepskyblue">0136:</font>     float3 V = normalize(EyePos  -In.Pos.xyz);<font color="cyan">// _xNg</font>
<font color="deepskyblue">0137:</font>     float3 L = normalize(LightPos-In.Pos.xyz);<font color="cyan">// CgxNg</font>
<font color="deepskyblue">0138:</font>     float3 H = normalize(L+V);              <font color="cyan">// n[txNg</font>
<font color="deepskyblue">0139:</font> 
<font color="deepskyblue">0140:</font>     <font color="cyan">// exNgeNX`W֕ϊ</font>
<font color="deepskyblue">0141:</font>     Out.v = Q(V, B,T,N);
<font color="deepskyblue">0142:</font>     Out.l = Q(L, B,T,N);
<font color="deepskyblue">0143:</font>     Out.h = Q(H, B,T,N);
<font color="deepskyblue">0144:</font>     
<font color="deepskyblue">0145:</font>     <font color="cyan">// Ƃ肠ACgɊւĔwʂ̏</font>
<font color="deepskyblue">0146:</font>     Out.Intensity = Out.l.a;
<font color="deepskyblue">0147:</font> 
<font color="deepskyblue">0148:</font>     <font color="cyan">// ʒuW</font>
<font color="deepskyblue">0149:</font>     <font color="yellow">Out.Nv = mul( In.Normal, mWV_IT );</font>
<font color="deepskyblue">0150:</font>     
<font color="deepskyblue">0151:</font> 
<font color="deepskyblue">0152:</font>     <font color="blue">return</font> Out;
<font color="deepskyblue">0153:</font> }
</pre>

<p>
ȂAAvP[VvOł́Â悤ȍ\ŃeNX`ǂݍŁAƂ͕ʂ̃eNX`Ɠ悤Ɏ舵܂B
</p>
<pre class="CodeBlock">
main.cpp
<font color="deepskyblue">0189:</font> HRESULT CMyD3DApplication::InitDeviceObjects()
<font color="deepskyblue">0190:</font> {
<font color="deepskyblue">0191:</font>     HRESULT hr;
<font color="deepskyblue">0192:</font>     LPCTSTR pErrMsg;
<font color="deepskyblue">0193:</font> 
<font color="deepskyblue">0194:</font>     hr = HDR::CreateTextureFromFile(m_pd3dDevice, "<SPAN CLASS="string">galileo_probe.hdr</font>", &amp;pErrMsg, &amp;m_pEnvMap);
<font color="deepskyblue">0195:</font>     <font color="blue">if</font>(FAILED(hr)){
<font color="deepskyblue">0196:</font>         MessageBox( NULL, pErrMsg, "<SPAN CLASS="string">ERROR</font>", MB_OK);
<font color="deepskyblue">0197:</font>     }
ȉ
</pre>


<h2>Ō</h2>


<p>
͂`Al̃vOǂނ͔̂܂ȁB<br>
܂܂sSȂ̂ŁASȃvOɏCꂽ͂ǂB
</p>
<p>
ƁAK}␳ƂI␳SRĂȂ̂ŁA̓_Ǝv܂B
</p>


</div>
<BR CLEAR=ALL>
<BR CLEAR=ALL>
<BR CLEAR=ALL>
<center>
<hr>
<p><a href="../index.html">ǂ</a></p>
<p><a href="mailto:imagire@nifty.com">imagire@nifty.com</a></p>
</center>

</body>
</html>